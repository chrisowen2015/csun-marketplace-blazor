@page "/cart"
@using System.Globalization
@using csun_marketplace.data;
@using csun_marketplace.services;
@using System;
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity

@inject ICSUNMarketplaceService _csunMarketplaceService
@inject IWebHostEnvironment env
@inject ISnackbar Snackbar
@inject NavigationManager _navMan
@inject AuthenticationStateProvider _authenticationStateProvider
@inject CartService _cart

<MudPaper Class="page-container" Elevation="7">
    <div class="page-content">

        <div class="page-header-container">
            <MudText Class="form-header" Color="Color.Default">
                <h1>
                    My cart
                </h1>
                <h6>
                    In my cart:
                </h6>
            </MudText>
        </div>

        @if (_cart.Length() > 0)
        {
            @foreach (Product p in _cart.GetCart())
            {
                <MudPaper Style="margin-left: 1em; margin-right: 1em; margin-bottom: 1em; padding: .5em;" Elevation="3">
                    <MudContainer Class="cart-product-flex-row" Fixed="true">
                        <div class="cart-product-img-small">
                            <MudImage Src="@p.ImageUrl" Height="120" Width="120" />
                        </div>
                        <div class="cart-popover-title-price-flex-col">
                            <p> @p.Title </p>
                            <b class="product-price-text"> @formatCurrency(p.Price) </b>
                        </div>
                        <MudIconButton Class="cart-remove-icon" Icon="@Icons.Material.Filled.Delete" OnClick="@(()=> RemoveFromCart(p))" />
                    </MudContainer>
                </MudPaper>
            }
        }

        <div class="grid-two">
            <div class="keep-shopping">
                <MudButton Variant="Variant.Filled" OnClick="@(()=>_navMan.NavigateTo("/"))" Color="Color.Primary">Keep Shopping</MudButton>
            </div>

            @if (_cart.Length() > 0)
            {
                <div class="billing-continue">
                    <MudText>
                        Cart Total: $@_cart.GetTotal().ToString()
                    </MudText>
                    <MudButton Variant="Variant.Filled" OnClick="@(()=>_navMan.NavigateTo("/checkout"))" Color="Color.Primary">Checkout</MudButton>
                </div>
            }
        </div>

    </div>
</MudPaper>



@code {

    CultureInfo USD = new CultureInfo("en-US");

    public string formatCurrency(decimal? amount)
    {
        float subtotal = (float)amount;
        return subtotal.ToString("C2", USD);
    }

    public void RemoveFromCart(Product p)
    {
        _cart.RemoveFromCart(p);
        Snackbar.Add("Product successfully removed from Cart.", Severity.Success, config =>
        {
            config.Action = "Undo";
            config.ActionColor = Color.Secondary;
            config.Onclick = snackbar =>
            {
                _cart.UndoRemoveFromCart();
                Snackbar.Clear();
                return Task.CompletedTask;
            };
        });
    }

}

<style>
    .upload-image-label {
        margin-left: 1em;
    }

    .img-input-div {
        margin-top: 1em;
    }

    .grid-two {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between;
        padding-top: .5em;
        padding-bottom: .5em;
        padding-left: 1em;
        padding-right: 1em;
    }

    .elem-half {
        max-width: 48%;
    }


    .products-container {
        display: flex !important;
        flex-direction: row !important;
        flex-flow: row wrap;
        justify-content: space-evenly;
        gap: 16px;
        padding-top: .5em;
        padding-bottom: .5em;
        padding-left: 1em;
        padding-right: 1em;
    }

    .grid-two {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between;
        padding-top: .5em;
        padding-bottom: .5em;
        padding-left: 1em;
        padding-right: 1em;
    }

    .keep-shopping {
        float: left;
        padding-top: 24px;
    }

    .billing-continue {
        float: right;
    }
</style>
